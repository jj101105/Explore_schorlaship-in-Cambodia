<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cambodia Scholarship Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .chat-container {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 70vh;
      max-height: 90vh;
    }
    .chat-header {
      background-color: #4f46e5;
      color: white;
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      border-top-left-radius: 1.5rem;
      border-top-right-radius: 1.5rem;
    }
    .chat-messages {
      flex-grow: 1;
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }
    .message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
      white-space: pre-line;
      position: relative;
    }
    .message.user {
      background-color: #e0e7ff;
      align-self: flex-end;
      border-bottom-right-radius: 0.25rem;
    }
    .message.bot {
      background-color: #f3f4f6;
      align-self: flex-start;
      border-bottom-left-radius: 0.25rem;
    }
    .chat-input-container {
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    .chat-input {
      flex-grow: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.75rem;
      outline: none;
      font-size: 1rem;
    }
    .chat-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    .send-button {
      background-color: #4f46e5;
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      border: none;
    }
    .send-button:hover {
      background-color: #4338ca;
    }
    .clear-button {
      background-color: #e5e7eb;
      color: #4f46e5;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      margin-left: 0.5rem;
      transition: background-color 0.2s;
    }
    .clear-button:hover {
      background-color: #c7d2fe;
    }
    .loading-indicator {
      align-self: flex-start;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      background-color: #f3f4f6;
      color: #6b7280;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #a5b4fc;
      border-radius: 50%;
      margin-right: 2px;
      animation: blink 1.2s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .suggestion-btn {
      background: #e0e7ff;
      color: #4f46e5;
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-btn:hover {
      background: #c7d2fe;
    }
    .error-message {
      color: #dc2626;
      font-size: 0.95rem;
      margin-top: 0.5rem;

      font-style: italic;
    }
  </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
  <a href="../index.html" class="back-link">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </svg>
  </a>
  Scholarship Bot (Cambodia)
</div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-container">
      <input type="text" id="user-input" class="chat-input" placeholder="Type your message..." autocomplete="off" />
      <button id="send-button" class="send-button">Send</button>
      <button id="clear-button" class="clear-button">Clear</button>
    </div>
  </div>
 
  <script>
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const clearButton = document.getElementById('clear-button');
    const chatMessages = document.getElementById('chat-messages');

    // Scholarships data will be loaded from the backend
    let scholarshipsData = [];

    async function loadScholarships() {
      try {
        const response = await fetch('../php/get_scholarships.php');
        scholarshipsData = await response.json();
      } catch (e) {
        scholarshipsData = [];
        displayError("Failed to load scholarships from database.");
      }
    }

    // Session context
    let chatHistory = [];

    // Welcome message and suggestions
    function welcomeMessage() {
      displayMessage("ðŸ‘‹ Hello! I'm your Scholarship Bot. I can provide information about scholarships in Cambodia. What would you like to know?", "bot");
      displaySuggestions();
    }

    function displaySuggestions() {
      const suggestions = [
        "Show me all scholarships for undergraduate.",
        "What are the eligibility criteria for Australia Awards?",
        "List scholarships for business field.",
        "Deadlines for scholarships in 2025?",
        "Which scholarships are fully funded?"
      ];
      const suggestionWrap = document.createElement('div');
      suggestionWrap.className = "message bot";
      const label = document.createElement('div');
      label.innerHTML = "<strong>Quick questions:</strong>";
      suggestionWrap.appendChild(label);

      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = "suggestions";
      suggestions.forEach(q => {
        const btn = document.createElement('button');
        btn.textContent = q;
        btn.className = "suggestion-btn";
        btn.onclick = () => {
          userInput.value = q;
          processUserInput();
        };
        suggestionsDiv.appendChild(btn);
      });
      suggestionWrap.appendChild(suggestionsDiv);
      chatMessages.appendChild(suggestionWrap);
      smoothScrollToBottom();
    }

    // Display message
    function displayMessage(message, sender) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('message', sender);
      messageElement.textContent = message;
      chatMessages.appendChild(messageElement);
      smoothScrollToBottom();
    }

    // Display error message
    function displayError(message) {
      const errorElement = document.createElement('div');
      errorElement.className = 'error-message';
      errorElement.textContent = message;
      chatMessages.appendChild(errorElement);
      smoothScrollToBottom();
    }

    // Loading animation
    function showLoading() {
      const loadingElement = document.createElement('div');
      loadingElement.classList.add('loading-indicator');
      loadingElement.id = 'loading-indicator';
      loadingElement.innerHTML = 'Bot is typing <span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      chatMessages.appendChild(loadingElement);
      smoothScrollToBottom();
    }

    function hideLoading() {
      const loadingElement = document.getElementById('loading-indicator');
      if (loadingElement) loadingElement.remove();
    }

    // Smooth scroll
    function smoothScrollToBottom() {
      chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
    }


    // Reset chat
    function resetChat() {
      chatMessages.innerHTML = '';
      chatHistory = [];
      userInput.value = '';
      userInput.focus();
      welcomeMessage();
    }

    // Gemini API call with session context
    async function getGeminiResponse(prompt) {
      // Compose session context for Gemini
      const history = chatHistory.map(msg => ({
        role: msg.sender === "user" ? "user" : "model",
        parts: [{ text: msg.text }]
      }));
      history.push({ role: "user", parts: [{ text: prompt }] });

      const payload = {
        contents: history,
        generationConfig: { responseMimeType: "text/plain" }
      };

      const apiKey = "AIzaSyA0wgstSIvpJeGYg9FM74_r8Ole6GcgNHc";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (
          result.candidates &&
          result.candidates.length > 0 &&
          result.candidates[0].content &&
          result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0
        ) {
          return result.candidates[0].content.parts[0].text;
        } else {
          return "Sorry, I couldn't generate a response. Please try again.";
        }
      } catch (error) {
        return "Sorry, I'm having trouble connecting right now. Please try again later.";
      }
    }

    // Process user input
    async function processUserInput() {
      const userText = userInput.value.trim();
      if (userText === '' || sendButton.disabled) return;

      displayMessage(userText, 'user');
      chatHistory.push({ sender: "user", text: userText });
      userInput.value = '';
      sendButton.disabled = true;
      userInput.disabled = true;
      showLoading();

   const scholarshipInfo = scholarshipsData
        .map(s =>
          `Name: ${s.title}
University: ${s.university}
Field: ${s.major || 'N/A'}
Eligibility: ${Array.isArray(s.eligibility) ? s.eligibility.join('; ') : s.eligibility || 'N/A'}
Deadline: ${s.details?.deadline || 'N/A'}
Type: ${s.details?.type || 'N/A'}
Benefits: ${Array.isArray(s.benefits) ? s.benefits.join('; ') : s.benefits || 'N/A'}`
        ).join('\n\n---\n\n');


      // UPDATED PROMPT: Instruct bot not to use asterisk (*) if it doesn't have info
      const prompt = `
You are a helpful chatbot providing information about scholarships in Cambodia.

Here is the list of scholarships I can help with:

${scholarshipInfo}

Based on the user's question below, answer clearly and concisely using only the information above. 
If you don't know the answer, say you don't have that information. Do not use an asterisk (*) in your reply.

User question: ${userText}
`;

      let botResponse = await getGeminiResponse(prompt);
      hideLoading();

      if (!botResponse || botResponse.trim() === '') {
        displayError("Sorry, I couldn't generate a response. Please try again.");
      } else {
        displayMessage(botResponse.trim(), 'bot');
        chatHistory.push({ sender: "bot", text: botResponse.trim() });
      }

      sendButton.disabled = false;
      userInput.disabled = false;
      userInput.focus();
    }

    // Event listeners
    sendButton.addEventListener('click', processUserInput);
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') processUserInput();
    });
    clearButton.addEventListener('click', resetChat);

    // Autofocus input on load and load scholarships
    window.onload = async () => {
      userInput.focus();
      await loadScholarships();
      welcomeMessage();
    };
  </script>
</body>
</html>
